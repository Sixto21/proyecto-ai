# GitLab CI/CD Pipeline
# Configuraci√≥n para testing automatizado y deployment

stages:
  - test
  - lint
  - build
  - deploy

# Variables globales
variables:
  PYTHON_VERSION: "3.13"
  NODE_VERSION: "20"

# Template para trabajos de Python
.python_template: &python_job
  image: python:${PYTHON_VERSION}
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt

# Template para trabajos de Node.js
.node_template: &node_job
  image: node:${NODE_VERSION}
  before_script:
    - npm install

# ============================================
# STAGE: TEST
# ============================================

test:tp2:
  <<: *python_job
  stage: test
  script:
    - cd TP2
    - pip install -r requirements.txt
    - python -m py_compile main.py
    - python -m py_compile chatbot_basico.py
  only:
    changes:
      - TP2/**/*

test:tp3:
  <<: *node_job
  stage: test
  script:
    - cd TP3
    - npm install
    - node -c server.js  # Syntax check
  only:
    changes:
      - TP3/**/*

test:tp5:
  <<: *python_job
  stage: test
  script:
    - cd TP5
    - python -m py_compile chatbot_mejorado.py
  only:
    changes:
      - TP5/**/*

test:tp6:
  <<: *python_job
  stage: test
  script:
    - cd TP6
    - pip install -r requirements.txt
    - python -m py_compile app.py
  only:
    changes:
      - TP6/**/*

# ============================================
# STAGE: LINT
# ============================================

lint:python:
  image: python:${PYTHON_VERSION}
  stage: lint
  before_script:
    - pip install flake8 pylint
  script:
    - find . -name "*.py" -not -path "./venv/*" | xargs flake8 --max-line-length=100 --ignore=E501,W503 || true
    - echo "‚úÖ Linting completado (warnings permitidos)"
  allow_failure: true

lint:markdown:
  image: node:${NODE_VERSION}
  stage: lint
  before_script:
    - npm install -g markdownlint-cli
  script:
    - markdownlint '**/*.md' --ignore node_modules --ignore venv || true
    - echo "‚úÖ Markdown lint completado"
  allow_failure: true

# ============================================
# STAGE: BUILD
# ============================================

build:documentation:
  image: python:${PYTHON_VERSION}
  stage: build
  script:
    - echo "üìö Generando documentaci√≥n..."
    - mkdir -p public
    - cp README.md public/
    - cp CHANGELOG.md public/
    - cp CONTRIBUTING.md public/
    - echo "‚úÖ Documentaci√≥n generada"
  artifacts:
    paths:
      - public
    expire_in: 1 week
  only:
    - main

# ============================================
# STAGE: DEPLOY
# ============================================

deploy:pages:
  stage: deploy
  script:
    - echo "üöÄ Desplegando GitLab Pages..."
    - mkdir -p public
    - cp -r docs/* public/ || true
    - echo "‚úÖ Pages desplegado"
  artifacts:
    paths:
      - public
  only:
    - main

# ============================================
# TRABAJOS MANUALES
# ============================================

deploy:heroku:
  stage: deploy
  image: ruby:latest
  before_script:
    - apt-get update -qq && apt-get install -y -qq git
    - gem install dpl
  script:
    - echo "üöÄ Deploy a Heroku (manual)"
    - echo "Configurar HEROKU_API_KEY en CI/CD variables"
  when: manual
  only:
    - main

# ============================================
# NOTIFICACIONES
# ============================================

success_notification:
  stage: .post
  script:
    - echo "‚úÖ Pipeline completado exitosamente!"
    - echo "Commit: $CI_COMMIT_SHORT_SHA"
    - echo "Branch: $CI_COMMIT_BRANCH"
    - echo "Autor: $CI_COMMIT_AUTHOR"
  when: on_success

failure_notification:
  stage: .post
  script:
    - echo "‚ùå Pipeline fall√≥"
    - echo "Revisar logs arriba"
  when: on_failure
